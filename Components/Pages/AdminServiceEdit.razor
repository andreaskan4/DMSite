@page "/admin/service/{Mode}/{Id:long?}"
@using DMsite.Models
@using DMsite.Services
@inject SupabaseService Supabase
@inject AuthService Auth
@inject NavigationManager Nav

<div class="container mt-4" style="max-width: 600px;">
    <h1>@(Mode == "new" ? "Προσθήκη Υπηρεσίας" : "Επεξεργασία Υπηρεσίας")</h1>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <strong>Σφάλμα:</strong> @errorMessage
        </div>
    }

    <EditForm Model="service" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="mb-3">
            <label class="form-label">Όνομα Υπηρεσίας</label>
            <InputText @bind-Value="service.Name" class="form-control" placeholder="π.χ. Θεραπευτική Μάλαξη" />
            <ValidationMessage For="@(() => service.Name)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Διάρκεια</label>
            <InputText @bind-Value="service.Duration" class="form-control" placeholder="π.χ. 45 λεπτά" />
            <ValidationMessage For="@(() => service.Duration)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Τιμή (€)</label>
            <InputNumber @bind-Value="service.Price" class="form-control" />
            <ValidationMessage For="@(() => service.Price)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Περιγραφή</label>
            <InputTextArea @bind-Value="service.Description" class="form-control" rows="4" />
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Αποθήκευση</button>
            <button type="button" class="btn btn-secondary" @onclick='() => Nav.NavigateTo("/admin")'>Ακύρωση</button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public string Mode { get; set; } = "new";
    [Parameter] public long? Id { get; set; }

    private Service service = new();
    private string? errorMessage;

    // ΠΡΟΣΘΗΚΗ: Φόρτωση του Session χρήστη μόλις ανοίξει η σελίδα
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Auth.InitializeAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (Mode == "edit" && Id.HasValue)
            {
                // Φόρτωση υπηρεσιών για επεξεργασία
                var allServices = await Supabase.GetServicesAsync();
                var found = allServices.FirstOrDefault(s => s.Id == Id.Value);
                if (found != null)
                {
                    service = found;
                }
                else
                {
                    Nav.NavigateTo("/admin");
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Πρόβλημα στη φόρτωση: " + ex.Message;
        }
    }

    private async Task HandleSubmit()
    {
        // Έλεγχος αν υπάρχει active session πριν την αποστολή
        if (!Auth.IsLoggedIn)
        {
            errorMessage = "Η συνεδρία έχει λήξει. Παρακαλώ συνδεθείτε ξανά.";
            return;
        }

        try
        {
            errorMessage = null;
            if (Mode == "new")
            {
                await Supabase.CreateServiceAsync(service);
            }
            else
            {
                await Supabase.UpdateServiceAsync(service);
            }

            Nav.NavigateTo("/admin");
        }
        catch (Exception ex)
        {
            errorMessage = "Η αποθήκευση απέτυχε. Λεπτομέρειες: " + ex.Message;
        }
    }
}